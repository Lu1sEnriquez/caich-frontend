<div class="profile-container">
  <!-- Header Card -->
  <div class="profile-header-card">
    <div class="header-background"></div>
    <div class="header-content">
      <div class="profile-avatar-section">
        <div class="avatar-wrapper">
          <app-avatar
            [src]="user()?.foto ? '../../../../assets/profiles/' + user()!.foto : ''"
            [name]="user()?.nombreCompleto || ''"
            size="xl"
            status="online"
          />
          <button class="avatar-upload-btn" (click)="uploadPhoto()" title="Cambiar foto">
            <span>üì∏</span>
          </button>
        </div>
        <div class="profile-header-info">
          <h1 class="profile-name">{{ user()?.nombreCompleto }}</h1>
          <p class="profile-email">{{ user()?.email }}</p>
          <div class="profile-meta">
            <span class="meta-item">
              <span class="meta-icon">üÜî</span>
              <span class="meta-text">ID #{{ user()?.id }}</span>
            </span>
            <app-badge [status]="user()?.rol || 'Paciente'">{{ user()?.rol }}</app-badge>
          </div>
        </div>
      </div>
      <div class="profile-quick-actions">
        <app-button variant="outline" size="sm" (clicked)="downloadData()">
          <span class="btn-icon">üì•</span>
          Descargar datos
        </app-button>
      </div>
    </div>
  </div>

  <!-- Loading State -->
  @if (profileResource.isLoading()) {
  <div class="state-card loading-card">
    <div class="state-icon">‚è≥</div>
    <h3>Cargando perfil</h3>
    <p>Obteniendo informacion desde el servidor...</p>
  </div>
  }

  <!-- Error State -->
  @if (profileResource.error() && !profileResource.isLoading()) {
  <div class="state-card error-card">
    <div class="state-icon">‚ùå</div>
    <h3>Error al cargar el perfil</h3>
    <p>{{ profileResource.error()?.message || 'Error desconocido' }}</p>
    <app-button variant="primary" size="sm" (clicked)="refreshProfile()">
      <span class="btn-icon">üîÑ</span>
      Reintentar
    </app-button>
  </div>
  }

  <!-- Main Content -->
  @if (!profileResource.isLoading() && !profileResource.error()) {
  <div class="profile-grid">
    <!-- Personal Information -->
    <div class="profile-section">
      <app-card>
        <div class="section-header">
          <div class="section-icon">üë§</div>
          <div class="section-title-group">
            <h2 class="section-title">Informacion personal</h2>
            <p class="section-description">Actualiza tus datos personales</p>
          </div>
        </div>
        <app-card-content>
          <form class="profile-form">
            <div class="form-group">
              <app-input
                label="Nombre completo"
                placeholder="Nombre completo"
                [(value)]="formData.nombreCompleto"
                [required]="true"
              />
            </div>
            <div class="form-group">
              <app-input
                label="Correo electronico"
                type="email"
                placeholder="correo@ejemplo.com"
                [(value)]="formData.email"
                [required]="true"
              />
            </div>
            <div class="form-row">
              <div class="form-group">
                <app-input
                  label="Telefono"
                  type="tel"
                  placeholder="0000000000"
                  [(value)]="formData.telefono"
                  [hint]="'10 digitos sin espacios'"
                />
              </div>
              <div class="form-group">
                <app-input
                  label="Folio (opcional)"
                  type="text"
                  placeholder="12345678"
                  [(value)]="formData.folio"
                />
              </div>
            </div>

            @if (updateResource.error()) {
            <div class="alert alert-error">
              <span class="alert-icon">‚ùå</span>
              <span>{{ updateResource.error()?.message || 'Error al actualizar' }}</span>
            </div>
            }

            <div class="form-actions">
              <app-button
                variant="primary"
                [disabled]="updateResource.isLoading()"
                (clicked)="saveProfile()"
              >
                @if (updateResource.isLoading()) {
                <span class="btn-icon">‚è≥</span>
                <span>Guardando...</span>
                } @else {
                <span class="btn-icon">üíæ</span>
                <span>Guardar cambios</span>
                }
              </app-button>
            </div>
          </form>
        </app-card-content>
      </app-card>
    </div>

    <!-- Security Settings -->
    <div class="profile-section">
      <app-card>
        <div class="section-header">
          <div class="section-icon">üîí</div>
          <div class="section-title-group">
            <h2 class="section-title">Seguridad</h2>
            <p class="section-description">Protege tu cuenta</p>
          </div>
        </div>
        <app-card-content>
          <div class="security-section">
            <div class="security-item">
              <div class="security-item-content">
                <div class="security-icon">üîë</div>
                <div class="security-info">
                  <h4>Contrasena</h4>
                  <p>Ultima actualizacion hace 30 dias</p>
                </div>
              </div>
              <app-button variant="outline" size="sm" (clicked)="openPasswordDialog()">
                Cambiar
              </app-button>
            </div>
          </div>

          <!-- Password Change Dialog -->
          @if (showPasswordDialog()) {
          <div class="dialog-overlay" (click)="closePasswordDialog()">
            <div class="dialog" (click)="$event.stopPropagation()">
              <div class="dialog-header">
                <div class="dialog-title-group">
                  <div class="dialog-icon">üîí</div>
                  <h2>Cambiar contrasena</h2>
                </div>
                <button class="close-button" (click)="closePasswordDialog()">‚úï</button>
              </div>
              <div class="dialog-content">
                <p class="dialog-description">
                  Ingresa tu contrasena actual y luego la nueva contrasena que deseas usar.
                </p>
                <form class="password-form">
                  <app-input
                    label="Contrasena actual"
                    type="password"
                    placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                    [(value)]="passwordForm.passwordActual"
                    [required]="true"
                  />
                  <app-input
                    label="Nueva contrasena"
                    type="password"
                    placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                    [(value)]="passwordForm.passwordNueva"
                    [required]="true"
                    [hint]="'Minimo 6 caracteres'"
                  />
                  <app-input
                    label="Confirmar nueva contrasena"
                    type="password"
                    placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                    [(value)]="passwordForm.confirmarPassword"
                    [required]="true"
                  />

                  @if (passwordResource.error()) {
                  <div class="alert alert-error">
                    <span class="alert-icon">‚ùå</span>
                    <span>{{ passwordResource.error()?.message || 'Error al cambiar contrasena' }}</span>
                  </div>
                  }
                </form>
              </div>
              <div class="dialog-footer">
                <app-button variant="outline" (clicked)="closePasswordDialog()">
                  Cancelar
                </app-button>
                <app-button
                  variant="primary"
                  [disabled]="passwordResource.isLoading()"
                  (clicked)="changePassword()"
                >
                  @if (passwordResource.isLoading()) {
                  <span class="btn-icon">‚è≥</span>
                  <span>Cambiando...</span>
                  } @else {
                  <span class="btn-icon">üîí</span>
                  <span>Cambiar contrasena</span>
                  }
                </app-button>
              </div>
            </div>
          </div>
          }
        </app-card-content>
      </app-card>
    </div>
  </div>

  <!-- Additional Info Cards -->
  <div class="info-grid">
    <!-- Account Details -->
    <app-card class="info-card">
      <div class="section-header compact">
        <div class="section-icon small">‚ÑπÔ∏è</div>
        <div class="section-title-group">
          <h2 class="section-title">Detalles de cuenta</h2>
        </div>
      </div>
      <app-card-content>
        <div class="info-list">
          <div class="info-item">
            <span class="info-label">ID de Usuario</span>
            <span class="info-value">{{ user()?.id }}</span>
          </div>
          <div class="info-item">
            <span class="info-label">Rol</span>
            <span class="info-value">
              <app-badge [status]="user()?.rol || 'Paciente'">{{ user()?.rol }}</app-badge>
            </span>
          </div>
          <div class="info-item">
            <span class="info-label">Correo electronico</span>
            <span class="info-value">{{ user()?.email }}</span>
          </div>
        </div>
      </app-card-content>
    </app-card>

    <!-- Quick Actions -->
    <app-card class="info-card">
      <div class="section-header compact">
        <div class="section-icon small">‚ö°</div>
        <div class="section-title-group">
          <h2 class="section-title">Acciones rapidas</h2>
        </div>
      </div>
      <app-card-content>
        <div class="quick-actions-list">
          <button class="quick-action-item" (click)="downloadData()">
            <div class="quick-action-icon">üì•</div>
            <div class="quick-action-info">
              <h4>Descargar datos</h4>
              <p>Exporta tu informacion en formato JSON</p>
            </div>
            <span class="quick-action-arrow">‚Üí</span>
          </button>
          <button class="quick-action-item" (click)="uploadPhoto()">
            <div class="quick-action-icon">üì∏</div>
            <div class="quick-action-info">
              <h4>Cambiar foto</h4>
              <p>Actualiza tu foto de perfil</p>
            </div>
            <span class="quick-action-arrow">‚Üí</span>
          </button>
        </div>
      </app-card-content>
    </app-card>
  </div>
  }
</div>
