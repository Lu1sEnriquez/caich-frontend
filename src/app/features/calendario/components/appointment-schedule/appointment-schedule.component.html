<div class="schedule-container">
  <!-- Header con fecha seleccionada -->
  <div class="schedule-header">
    <div class="header-info">
      <h3>Agenda del d√≠a</h3>
      <p>{{ formatDate(selectedDate()) }}</p>
    </div>
    <div class="header-actions">
      <app-button variant="outline" size="sm" (clicked)="toggleConfigMode()">
        {{ configMode() ? 'Cancelar' : '‚öôÔ∏è Configurar horario' }}
      </app-button>
      <app-button variant="primary" size="sm" (clicked)="openNewAppointment()">
        + Nueva cita
      </app-button>
    </div>
  </div>

  <!-- Estados de carga y error -->
  @if (isLoading()) {
  <div class="loading-overlay">
    <div class="loading-content">
      <p>üîÑ Cargando agenda...</p>
    </div>
  </div>
  } @if (hasError()) {
  <div class="error-container">
    <div class="error-content">
      <p>‚ùå Error al cargar los datos</p>
      <app-button variant="outline" size="sm" (clicked)="reloadData()"> Reintentar </app-button>
    </div>
  </div>
  }

  <!-- Modo configuraci√≥n -->
  @if (configMode() && !isLoading() && !hasError()) {
  <app-card>
    <div class="config-section">
      <h4>Configurar horarios disponibles</h4>

      <!-- Selecci√≥n de espacio -->
      <div class="form-field">
        <label>Seleccionar espacio para configurar</label>

        <select class="select-input" [(ngModel)]="selectedEspacioIdModel" (ngModelChange)="onEspacioSelected($event)"
          name="espacio">
          <option [ngValue]="null">Selecciona un espacio</option>

          @for (cubiculo of cubiculos(); track cubiculo.id) {
          <option [ngValue]="cubiculo.id">{{ cubiculo.nombre }}</option>
          }
        </select>
      </div>

      <!-- Mostrar horarios solo si ya eligi√≥ un espacio -->
      @if (selectedEspacioId()) {
      <p class="config-subtitle">Selecciona las horas que NO estar√°n disponibles para este d√≠a</p>

      <div class="time-slots-config">
        @for (slot of allTimeSlots(); track slot) {
        <button class="time-slot-config" [class.disabled]="isHourDisabled(slot)" (click)="toggleHourAvailability(slot)">
          {{ slot }}
          @if (isHourDisabled(slot)) {
          <span class="disabled-badge">‚ùå</span>
          }
        </button>
        }
      </div>

      <div class="config-actions">
        <app-button variant="outline" (clicked)="cancelConfig()"> Cancelar </app-button>
        <app-button variant="primary" (clicked)="saveConfig()"> Guardar configuraci√≥n </app-button>
      </div>
      }
    </div>
  </app-card>
  }

  <!-- Tabla de horarios - PRESENCIALES -->
  @if (!isLoading() && !hasError()) {
  <div class="presenciales-section">
    <h4 class="section-title">üìç Citas Presenciales (por cub√≠culo)</h4>
    
    @if (appointmentsPresenciales().length === 0) {
      <p class="empty-section">No hay citas presenciales para este d√≠a</p>
    } @else {
    <div class="schedule-table-wrapper" #tableWrapper>
      <table class="schedule-table">
        <!-- Header con horas -->
        <thead>
          <tr>
            <th class="cubiculo-header">Cub√≠culo</th>
            @for (hour of hours(); track hour) {
            <th class="hour-header" [class.disabled]="isHourDisabled(hour)" [class.current-hour]="isCurrentHour(hour)">
              <div class="hour-content">
                {{ hour }}
                @if (isCurrentHour(hour)) {
                <span class="current-indicator">‚óè</span>
                } @if (isHourDisabled(hour)) {
                <span class="disabled-indicator">üö´</span>
                }
              </div>
            </th>
            }
          </tr>
        </thead>

        <!-- Body con cub√≠culos y citas -->
        <tbody>
          @for (cubiculo of cubiculos(); track cubiculo.id) {
          <tr>
            <!-- Nombre del cub√≠culo -->
            <td class="cubiculo-cell">
              <div class="cubiculo-info">
                <strong>{{ cubiculo.nombre }}</strong>
              </div>
            </td>

            <!-- Celdas de horas -->
            @for (hour of hours(); track hour; let colIndex = $index) { @if
            (!shouldSkipCell(cubiculo.id, hour)) {
            <td class="time-cell" [class.disabled]="isHourDisabled(hour)" [class.current-hour]="isCurrentHour(hour)"
              [attr.colspan]="
                getAppointmentAt(cubiculo.id, hour)
                  ? getAppointmentSpan(getAppointmentAt(cubiculo.id, hour)!)
                  : 1
              " (click)="onCellClick(cubiculo.id, hour)">
              @if (getAppointmentAt(cubiculo.id, hour); as appointment) {
              <div class="appointment-block" [class.estado-agendada]="appointment.estado === 'AGENDADO'"
                [class.estado-completada]="appointment.estado === 'COMPLETADO'"
                [class.estado-cancelada]="appointment.estado === 'CANCELADO'"
                [class.estado-progreso]="appointment.estado === 'EN_PROGRESO'"
                (click)="editAppointment(appointment); $event.stopPropagation()">
                <div class="appointment-content">
                  <strong class="patient-name">{{ appointment.pacienteNombre }}</strong>
                  <span class="cubicle-name">üìç {{ getCubiculoName(appointment.cubiculoId) }}</span>
                  <span class="appointment-time">
                    ‚è∞ {{ appointment.horaInicio }} - {{ appointment.horaFin }}
                  </span>
                  <span class="appointment-therapist"> üë§ {{ appointment.terapeutaNombre }} </span>
                  @if (appointment.estado === 'EN_PROGRESO') {
                  <span class="no-show-badge">‚è≥ En progreso</span>
                  }
                </div>
              </div>
              }
            </td>
            } }
          </tr>
          }
        </tbody>
      </table>
    </div>
    }
  </div>

  <!-- Secci√≥n de Citas ONLINE -->
  <div class="online-section">
    <h4 class="section-title">üíª Citas Online (sin conflictos)</h4>
    
    @if (appointmentsOnline().length === 0) {
      <p class="empty-section">No hay citas online para este d√≠a</p>
    } @else {
    <ul class="online-list">
      @for (appointment of appointmentsOnline(); track appointment.id) {
      <li class="online-item" [class.estado-agendada]="appointment.estado === 'AGENDADO'"
          [class.estado-completada]="appointment.estado === 'COMPLETADO'"
          [class.estado-cancelada]="appointment.estado === 'CANCELADO'"
          [class.estado-progreso]="appointment.estado === 'EN_PROGRESO'"
          (click)="editAppointment(appointment)">
        <div class="online-item-content">
          <span class="online-time">‚è∞ {{ appointment.horaInicio }} - {{ appointment.horaFin }}</span>
          <strong class="patient-name">{{ appointment.pacienteNombre }}</strong>
          <span class="therapist">üë§ {{ appointment.terapeutaNombre }}</span>
          @if (appointment.estado === 'EN_PROGRESO') {
            <span class="progress-badge">‚è≥ En progreso</span>
          }
          @if (appointment.notas) {
            <p class="notes-preview">üìù {{ appointment.notas }}</p>
          }
        </div>
      </li>
      }
    </ul>
    }
  </div>
  }

  <!-- Leyenda mejorada -->
  @if (!isLoading() && !hasError()) {
  <div class="legend">
    <div class="legend-title">Estado de las citas:</div>
    <div class="legend-items">
      <div class="legend-item">
        <span class="legend-color-agendada estado-agendada"></span>
        <span>Agendada</span>
      </div>
      <div class="legend-item">
        <span class="legend-color-completada estado-completada"></span>
        <span>Completada</span>
      </div>
      <div class="legend-item">
        <span class="legend-color-no-asistio estado-progreso"></span>
        <span>En progreso</span>
      </div>
      <div class="legend-item">
        <span class="legend-color-cancelada estado-cancelada"></span>
        <span>Cancelada</span>
      </div>
    </div>
  </div>
  }

 
</div>